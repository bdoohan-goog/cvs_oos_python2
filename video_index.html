<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif; /* You can change to Arial or other standard sans-serif if preferred */
            background-color: #F7F7F7; /* Very light grey background */
            color: #333333; /* Dark grey for primary text */
        }
        .loading-spinner { /* Changed from loading-sun */
            animation: spin 1.8s linear infinite;
            width: 2.5rem; height: 2.5rem;
            border: 4px solid #CCCCCC; /* Medium Grey */
            border-top-color: #A70000; /* CVS Red */
            border-radius: 50%;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #video-preview {
            width: 100%;
            aspect-ratio: 16 / 9;
            max-height: 400px;
            border-radius: 0.5rem; /* Kept rounded corners, can be squared */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            background-color: #E0E0E0; /* Light grey placeholder background */
        }
        .video-error { color: #D32F2F; font-size: 0.875rem; margin-top: 0.5rem; } /* Darker red for errors */
        
        .bq-table-container { max-height: 300px; overflow-y: auto; border: 1px solid #D1D5DB; border-radius: 0.5rem; } /* gray-300 */
        .bq-table table { width: 100%; table-layout: fixed; border-collapse: separate; border-spacing: 0; }
        .bq-table th, .bq-table td {
            padding: 10px 12px; text-align: left; font-size: 0.75rem; 
            border-bottom: 1px solid #E5E7EB; /* gray-200 */
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .bq-table td { color: #374151; } /* gray-700 */
        .bq-table th { background-color: #F3F4F6; color: #1F2937; font-weight: 600; position: sticky; top: 0; z-index: 10; border-bottom-width: 2px; border-bottom-color: #D1D5DB; } /* gray-100 bg, gray-800 text, gray-300 border */
        .bq-table tr:hover td { background-color: #F9FAFB; } /* gray-50 */

        #video-select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%236B7280"%3E%3Cpath fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /%3E%3C/svg%3E'); /* gray-500 for icon */
            background-color: #FFFFFF; border-color: #9CA3AF; color: #1F2937; /* gray-400 border, gray-800 text */
            background-repeat: no-repeat; background-position: right 0.75rem center; padding-right: 2.5rem; 
        }
        #video-select:focus { border-color: #A70000; box-shadow: 0 0 0 3px rgba(167, 0, 0, 0.2); } /* CVS Red focus */

        .result-card { background-color: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-top: 1.5rem;}
        .result-card h4, .result-card h5 { color: #A70000; font-weight: 600; margin-bottom: 0.75rem; } /* CVS Red */
        .result-card pre { background-color: #F9FAFB; border: 1px solid #E5E7EB; padding: 1rem; border-radius: 0.375rem; overflow-x: auto; font-size: 0.8rem; max-height: 250px; color: #111827;} /* gray-50 bg, gray-200 border, gray-900 text */
        
        .image-gallery-grid { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; justify-content: flex-start; }
        
        .image-gallery-grid .img-wrapper {
            height: 100px; width: 140px;
            border-radius: 0.375rem; overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #E5E7EB; /* gray-200 */
            transform: rotate(270deg);
        }
        .image-gallery-grid img { 
                width: 100%; 
                height: 100%; 
                object-fit: cover; 
                transform: rotate(180deg); /* Add this line */
            }
        .image-gallery-grid .img-wrapper:hover { transform: scale(1.05); box-shadow: 0 2px 6px rgba(0,0,0,0.15); transform: rotate(270deg); }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30,30,30,0.85);
            display: none; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; transform: rotate(270deg);
        }
        .modal img { max-width: 90%; max-height: 90%; border-radius: 0.375rem; box-shadow: 0 0 25px rgba(0,0,0,0.5); }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.75rem; color: #A70000; border-bottom: 2px solid #E5E7EB; padding-bottom: 0.5rem; } /* CVS Red, gray-200 border */
        .cvs-red-button {
            background-color: #A70000; /* CVS Red */
            color: #FFFFFF; /* White text */
        }
        .cvs-red-button:hover {
            background-color: #8F0000; /* Darker CVS Red on hover */
        }
        .cvs-red-button:disabled {
            background-color: #D1D5DB; /* gray-300 */
            color: #6B7280; /* gray-500 */
        }
        .upload-button { /* Style for upload button link */
            background-color: #6B7280; /* Medium Gray */
            color: #FFFFFF;
        }
        .upload-button:hover {
            background-color: #4B5563; /* Darker Gray */
        }

    </style>
</head>
<body>
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="text-center mb-12">
            <h1 class="text-5xl font-bold text-[#A70000]">Video Analyzer</h1> {/* CVS Red */}
            <p class="text-xl text-gray-600 mt-3">Extracting insights from video data.</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6 sm:p-10">
            <div class="mb-10">
                <a href="https://uploader-624436520964.us-east1.run.app/" target="_blank"
                   class="block w-full upload-button font-semibold py-3 px-6 rounded-md transition duration-300 ease-in-out text-center shadow hover:shadow-md mb-6 text-lg">
                    Upload New Video
                </a>
                <h2 class="text-3xl font-semibold mb-4 text-gray-800">Select Video to Analyze</h2>
                <p id="video-list-status" class="text-sm text-gray-500 mb-3">Loading video list...</p>
                <div class="flex flex-col sm:flex-row items-center sm:space-x-4">
                    <select id="video-select" class="flex-grow appearance-none w-full sm:w-auto mb-3 sm:mb-0 py-3 px-4 border-2 rounded-md leading-tight focus:outline-none focus:shadow-outline text-base">
                        <option value="">-- Choose a Video --</option>
                    </select>
                    <button id="process-selected-button"
                            class="w-full sm:w-auto cvs-red-button font-bold py-3.5 px-8 rounded-md transition duration-200 disabled:opacity-60 disabled:cursor-not-allowed shadow hover:shadow-md text-base">
                        Analyze Selected Video
                    </button>
                </div>
            </div>

            <div id="status-indicator" class="hidden text-center my-8">
                <div class="flex items-center justify-center space-x-3 mb-3">
                    <div class="loading-spinner rounded-full"></div> {/* Updated class */}
                    <span class="text-2xl font-medium text-gray-700">Processing your video...</span>
                </div>
                <div id="current-file-display" class="text-gray-600 text-lg"></div>
            </div>
            
            <div id="results-area" class="hidden">
                <div id="media-display-area" class="result-card bg-gray-50 border border-gray-200 mb-8">
                    <h3 class="section-title">Media Insights</h3>
                    <div id="video-container" class="my-4">
                        <video id="video-preview" controls muted loop playsinline preload="metadata">
                            Your browser does not support the video tag.
                            </video>
                        <div id="video-error" class="video-error hidden"></div>
                    </div>
                    <div id="related-image-gallery-container" class="hidden"> {/* Renamed from oos-image-gallery-container */}
                        <h4 class="text-gray-700 font-semibold text-lg mt-6 mb-3">Related Frame Previews:</h4>
                        <div id="related-image-gallery" class="image-gallery-grid p-3 bg-gray-100 rounded-lg"> {/* Renamed from oos-image-gallery */}
                            <p class="text-gray-500 text-sm">Loading related images...</p>
                        </div>
                    </div>
                </div>

                <div id="analysis-results-container">
                    <div id="result-details" class="result-card">
                        <h3 class="section-title">Gemini Analysis</h3>
                        <p id="result-status-message" class="text-md mb-4"></p>
                        <div class="mb-4">
                            <h4 class="text-gray-700">Processed File:</h4>
                            <p id="processed-file-display" class="text-gray-600 break-all text-md"></p>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-gray-700">BigQuery Note:</h4>
                            <pre id="bq-status-note" class="text-sm"></pre>
                        </div>
                        <div>
                            <h4 class="text-gray-700">Full Gemini Output:</h4>
                            <pre id="full-gemini-result" class="text-sm"></pre>
                        </div>
                    </div>

                    <div id="summary-details" class="result-card">
                        <h3 class="section-title">Grounding Summary</h3>
                        <pre id="grounded-upc-summary" class="text-sm"></pre>
                    </div>
                </div>
            </div>

            <div id="bq-preview-container" class="result-card mt-8">
                <h3 class="section-title">Recent Activity Dashboard (BigQuery)</h3>
                <div id="bq-preview-table" class="bq-table-container">
                    <p class="text-gray-500 p-4">Loading preview...</p>
                </div>
                <p id="bq-preview-error" class="text-sm text-red-600 mt-2 p-4 hidden"></p>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="this.style.display='none'">
        <img id="modalImage" src="" alt="Expanded Image" onclick="event.stopPropagation()">
    </div>

    <script>
        // DOM Elements
        const videoSelect = document.getElementById('video-select');
        const processButton = document.getElementById('process-selected-button');
        const videoListStatus = document.getElementById('video-list-status');
        const statusIndicatorDiv = document.getElementById('status-indicator');
        const currentFileDisplay = document.getElementById('current-file-display');
        // Ensure this is 'results-area' if you renamed the main container above for results
        const resultsContainer = document.getElementById('results-area'); // Changed from resultsArea to match HTML div id
        const mediaDisplayArea = document.getElementById('media-display-area');
        const videoPlayer = document.getElementById('video-preview');
        const videoErrorDiv = document.getElementById('video-error');
        
        const relatedImageGalleryContainer = document.getElementById('related-image-gallery-container'); 
        const relatedImageGalleryDiv = document.getElementById('related-image-gallery'); 

        const resultStatusMessage = document.getElementById('result-status-message');
        const processedFileDisplay = document.getElementById('processed-file-display');
        const bqStatusNotePre = document.getElementById('bq-status-note');
        const fullGeminiResultPre = document.getElementById('full-gemini-result');
        const groundedUPCSummaryPre = document.getElementById('grounded-upc-summary');
        const bqPreviewTableDiv = document.getElementById('bq-preview-table');
        const bqPreviewError = document.getElementById('bq-preview-error');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        let statusCheckInterval;
        let videoListInterval;
        let currentSelectedVideoURI = null;
        let currentPublicVideoUrl = null;

        function getFilenameFromUri(uri) {
            if (!uri) return 'Unknown File';
            try {
                if (uri.startsWith('gs://')) {
                    const parts = uri.split('/');
                    return parts.length > 3 ? parts.slice(3).join('/') : parts.pop() || uri;
                }
                return uri.split('/').pop() || uri;
            } catch { return uri; }
        }

        function generatePublicUrl(gsUri) {
            if (!gsUri || !gsUri.startsWith('gs://')) return null;
            const bucketAndPath = gsUri.substring(5);
            return `https://storage.googleapis.com/${bucketAndPath}`;
        }

        function fetchVideoList() {
            videoListStatus.textContent = 'Refreshing video list...';
            fetch('/list_videos')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.videos) {
                        videoListStatus.textContent = 'Select a video from the list.';
                        const currentSelectedValue = videoSelect.value;
                        videoSelect.innerHTML = '<option value="">-- Choose a Video --</option>';
                        data.videos.forEach(videoUri => {
                            const option = document.createElement('option');
                            option.value = videoUri;
                            option.textContent = getFilenameFromUri(videoUri);
                            videoSelect.appendChild(option);
                        });
                        if (videoSelect.querySelector(`option[value="${currentSelectedValue}"]`)) {
                            videoSelect.value = currentSelectedValue;
                        }
                        processButton.disabled = !videoSelect.value;
                    } else {
                        videoListStatus.textContent = `Error fetching videos: ${data.message || 'No videos found or error.'}`;
                        processButton.disabled = true;
                    }
                })
                .catch(error => {
                    videoListStatus.textContent = 'Network error loading videos.';
                    processButton.disabled = true;
                });
        }

        function fetchAndDisplayBQPreview() {
            bqPreviewTableDiv.innerHTML = '<p class="text-gray-500 p-4">Loading recent analyses...</p>';
            bqPreviewError.classList.add('hidden');
            fetch('/bq_preview')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.rows && data.rows.length > 0) {
                        bqPreviewTableDiv.innerHTML = generateTableHTML(data.rows);
                    } else if (data.status === 'success') {
                        bqPreviewTableDiv.innerHTML = '<p class="text-gray-500 p-4">No recent analyses found.</p>';
                    } else {
                        bqPreviewTableDiv.innerHTML = '';
                        bqPreviewError.textContent = `Error loading BQ preview: ${data.message || 'An error occurred'}`;
                        bqPreviewError.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    bqPreviewTableDiv.innerHTML = '';
                    bqPreviewError.textContent = 'Network error fetching BQ preview.';
                    bqPreviewError.classList.remove('hidden');
                });
        }
        
        function generateTableHTML(rows) {
            if (!rows || rows.length === 0) return '<p class="text-gray-500 p-4">No data to display.</p>';
            const headers = Object.keys(rows[0]);
            let tableHTML = '<table><thead><tr>';
            headers.forEach(header => {
                const formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                tableHTML += `<th>${formattedHeader}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            rows.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(header => {
                    const value = row[header];
                    let displayValue = (value !== null && value !== undefined) ? String(value) : '';
                     if ((header.toLowerCase() === 'time' || header.toLowerCase() === 'timestamp') && !isNaN(Date.parse(displayValue))) {
                         try { displayValue = new Date(displayValue).toLocaleString(); } catch(e){ /* keep as is */ }
                     }
                    if (typeof value === 'string' && value.length > 70 && (header.toLowerCase().includes('gemini') || header.toLowerCase().includes('feature') || header.toLowerCase().includes('details'))) {
                        displayValue = value.substring(0, 67) + '...';
                    }
                    tableHTML += `<td title="${String(value).replace(/"/g, '&quot;')}">${displayValue}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            return tableHTML;
        }

        function fetchRelatedImages(videoUri) { // Changed from fetchOOSImages
            if (!videoUri) {
                relatedImageGalleryContainer.classList.add('hidden');
                return;
            }
            mediaDisplayArea.classList.remove('hidden'); // Ensure media area is visible
            relatedImageGalleryContainer.classList.remove('hidden');
            relatedImageGalleryDiv.innerHTML = '<p class="text-gray-500 text-sm">Fetching related images...</p>';
            
            // Ensure this endpoint matches your backend (main.py)
            fetch(`/list_related_images?video_uri=${encodeURIComponent(videoUri)}`) 
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.images && data.images.length > 0) {
                        relatedImageGalleryDiv.innerHTML = ''; 
                        data.images.forEach(imgData => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'img-wrapper';
                            const imgElement = document.createElement('img');
                            imgElement.src = imgData.url;
                            imgElement.alt = imgData.name;
                            imgElement.title = imgData.name;
                            imgElement.onload = () => wrapper.style.backgroundColor = 'transparent';
                            imgElement.onerror = () => wrapper.innerHTML = '<p class="text-xs text-red-500 p-1">Error</p>';
                            wrapper.onclick = () => {
                                modalImage.src = imgData.url;
                                imageModal.style.display = 'flex';
                            };
                            wrapper.appendChild(imgElement);
                            relatedImageGalleryDiv.appendChild(wrapper);
                        });
                    } else if (data.status === 'success') {
                        relatedImageGalleryDiv.innerHTML = '<p class="text-gray-500 text-sm">No related images found for this video.</p>';
                    } else {
                        relatedImageGalleryDiv.innerHTML = `<p class="text-red-500 text-sm">Could not load related images: ${data.message || 'Error'}</p>`;
                    }
                })
                .catch(error => {
                    relatedImageGalleryDiv.innerHTML = '<p class="text-red-500 text-sm">Network error fetching related images.</p>';
                });
        }

        function processSelectedVideo() {
            currentSelectedVideoURI = videoSelect.value;
            if (!currentSelectedVideoURI) {
                alert('Please select a video from the list first!');
                return;
            }
            currentPublicVideoUrl = generatePublicUrl(currentSelectedVideoURI);
            
            resultsContainer.classList.add('hidden'); // Use the correct variable for the main results area
            relatedImageGalleryContainer.classList.add('hidden'); 
            relatedImageGalleryDiv.innerHTML = ''; 

            statusIndicatorDiv.classList.remove('hidden');
            currentFileDisplay.textContent = `Processing: ${getFilenameFromUri(currentSelectedVideoURI)}`;
            videoErrorDiv.classList.add('hidden');

            if (currentPublicVideoUrl) {
                mediaDisplayArea.classList.remove('hidden');
                videoPlayer.src = currentPublicVideoUrl;
                videoPlayer.load();
                videoPlayer.play().catch(e => console.warn('Video playback attempt failed:', e.message));
            } else {
                mediaDisplayArea.classList.add('hidden'); 
            }

            fetch('/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ video_uri: currentSelectedVideoURI })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'processing_started') {
                    if (statusCheckInterval) clearInterval(statusCheckInterval);
                    statusCheckInterval = setInterval(checkStatus, 2500);
                    checkStatus(); 
                } else {
                    alert(`Error starting processing: ${data.message}`);
                    statusIndicatorDiv.classList.add('hidden');
                    if(videoPlayer.src && !videoPlayer.paused) videoPlayer.pause();
                }
            })
            .catch(error => {
                alert('Network error initiating processing.');
                statusIndicatorDiv.classList.add('hidden');
                if(videoPlayer.src && !videoPlayer.paused) videoPlayer.pause();
            });
        }

        function checkStatus() {
            fetch('/status')
            .then(response => response.json())
            .then(data => {
                if (data.is_processing) {
                    currentFileDisplay.textContent = `Processing: ${data.current_file || getFilenameFromUri(currentSelectedVideoURI)}...`;
                    if (currentPublicVideoUrl) mediaDisplayArea.classList.remove('hidden');
                } else { 
                    if (statusCheckInterval) clearInterval(statusCheckInterval);
                    statusCheckInterval = null;

                    statusIndicatorDiv.classList.add('hidden');
                    resultsContainer.classList.remove('hidden'); // Use the correct variable 
                    mediaDisplayArea.classList.remove('hidden'); 

                    processedFileDisplay.textContent = data.current_file || getFilenameFromUri(currentSelectedVideoURI);
                    bqStatusNotePre.textContent = data.bq_row_message || 'BigQuery status details not specified.';

                    if (data.result && (data.result.status === 'completed' || data.result.status === 'completed_gemini_call')) {
                        resultStatusMessage.textContent = 'Analysis complete!';
                        resultStatusMessage.className = 'text-md mb-4 text-green-700 font-semibold'; // Adjusted color
                        try {
                            const geminiMessage = data.result.message; 
                            const geminiOutput = JSON.parse(geminiMessage);
                            
                            if (geminiOutput && geminiOutput.response && typeof geminiOutput.response === 'string' && geminiOutput.response.trim() !== "" && geminiOutput.response.trim() !== "[]" ) {
                                const productsJson = JSON.parse(geminiOutput.response);
                                fullGeminiResultPre.textContent = JSON.stringify(productsJson, null, 2);
                            } else if (geminiOutput && geminiOutput.error) { 
                                fullGeminiResultPre.textContent = `Gemini Error: ${geminiOutput.error}\nDetails: ${geminiOutput.details || 'N/A'}`;
                            } else if (geminiOutput && (geminiOutput.response === "[]" || geminiOutput.response === "")) {
                                fullGeminiResultPre.textContent = "Gemini analysis returned no specific products or an empty response.";
                            } else { 
                                fullGeminiResultPre.textContent = JSON.stringify(geminiOutput, null, 2);
                            }
                        } catch (e) { 
                            console.error("Error parsing Gemini result message:", e, "\nRaw message:", data.result.message);
                            fullGeminiResultPre.textContent = "Could not parse Gemini output. Raw content:\n" + data.result.message;
                        }
                        fetchRelatedImages(currentSelectedVideoURI); // Fetch related images on success
                    } else { 
                        const errorDetail = data.result ? data.result.message : 'Unknown processing error.';
                        resultStatusMessage.textContent = `Analysis error: ${typeof errorDetail === 'string' ? errorDetail : JSON.stringify(errorDetail, null, 2)}`;
                        resultStatusMessage.className = 'text-md mb-4 text-red-700 font-semibold'; // Adjusted color
                        fullGeminiResultPre.textContent = typeof errorDetail === 'string' ? errorDetail : JSON.stringify(errorDetail, null, 2);
                        relatedImageGalleryContainer.classList.add('hidden'); 
                    }

                    if (data.summary && data.summary.message) {
                        groundedUPCSummaryPre.textContent = data.summary.message;
                    } else {
                        groundedUPCSummaryPre.textContent = 'No grounding summary available or an error occurred during grounding.';
                    }
                    
                    fetchAndDisplayBQPreview();
                    if(videoPlayer.src && !videoPlayer.paused) videoPlayer.pause();
                }
            })
            .catch(error => {
                if (statusCheckInterval) clearInterval(statusCheckInterval);
                statusCheckInterval = null;
                statusIndicatorDiv.classList.add('hidden');
                resultsContainer.classList.remove('hidden'); // Use correct variable
                mediaDisplayArea.classList.remove('hidden');
                resultStatusMessage.textContent = 'Network error checking status.';
                resultStatusMessage.className = 'text-md mb-4 text-red-700 font-semibold'; // Adjusted color
                fetchAndDisplayBQPreview();
                if(videoPlayer.src && !videoPlayer.paused) videoPlayer.pause();
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetchVideoList();
            fetchAndDisplayBQPreview(); 
            videoListInterval = setInterval(fetchVideoList, 45000); // Periodically refresh video list

            videoSelect.addEventListener('change', () => {
                processButton.disabled = !videoSelect.value;
                currentSelectedVideoURI = videoSelect.value;
                currentPublicVideoUrl = generatePublicUrl(currentSelectedVideoURI);
                
                resultsContainer.classList.add('hidden'); // Use correct variable
                statusIndicatorDiv.classList.add('hidden');
                relatedImageGalleryContainer.classList.add('hidden');
                relatedImageGalleryDiv.innerHTML = '';


                if(currentPublicVideoUrl){
                    mediaDisplayArea.classList.remove('hidden'); 
                    videoPlayer.src = currentPublicVideoUrl;
                    videoPlayer.load(); 
                    videoErrorDiv.classList.add('hidden');
                } else {
                     mediaDisplayArea.classList.add('hidden'); 
                     videoPlayer.removeAttribute('src');
                }
            });

            processButton.addEventListener('click', processSelectedVideo);
            videoPlayer.addEventListener('error', (e) => {
                videoErrorDiv.textContent = `Video playback error: ${videoPlayer.error?.message || 'Unknown issue'}. URL: ${videoPlayer.currentSrc}`;
                videoErrorDiv.classList.remove('hidden');
            });
            videoPlayer.addEventListener('loadeddata', () => videoErrorDiv.classList.add('hidden'));
        });

        window.addEventListener('beforeunload', () => {
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            if (videoListInterval) clearInterval(videoListInterval);
        });
    </script>
</body>
</html>